/*
 * jqLocateMe library - target users geo-location.
 *   (http://brainstorage.me/pushthebutton)
 *
 * Copyright (c) 2014 Evgeniy Zakharov
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 * 
 *  Version: 06/05/2014 rc1
 */
var locateMe = function (h, c, i, k, j, f, e) { var a = this, d = j; this.isApplied = false; this.SearchInputLabel = jQuery("<span>").addClass("label").attr("id", c + "_label").html(i); this.SearchInput = jQuery("<input/>").addClass("input_search").attr("id", c).attr("type", "text"); this.SearchInputTip = jQuery("<input/>").addClass("input_search_tip").attr("id", c + "_tip").attr("type", "text"); this.SearchResultsTipId = jQuery("<input/>").attr("id", c + "_tip_id").attr("type", "hidden"); this.SearchResults = jQuery("<div>").addClass("results").attr("id", c + "_results"); this.SearchUrl = k; this.Reload = function (c) { if (c) { a.SearchInput.val(""); a.SearchInputTip.val(""); a.SearchResultsTipId.val(""); a.SearchResults.hide().empty() } b.setResultsPosition() }; this.Dispose = function () { this.isApplied = false; this.SearchInputLabel.remove(); this.SearchInput.unbind().remove(); this.SearchInputTip.remove(); this.SearchResultsTipId.remove(); this.SearchResults.unbind().remove(); a = null }; this.Disable = function (a) { if (a) { this.SearchInput.val("").attr("disabled", "disabled"); this.SearchInputTip.val("").attr("disabled", "disabled"); this.SearchInputLabel.addClass("disabled"); this.SearchResultsTipId.val(""); this.SearchResults.empty().hide() } else { this.SearchInput.removeAttr("disabled"); this.SearchInputTip.removeAttr("disabled"); this.SearchInputLabel.removeClass("disabled") } return this }; this.AjaxRequestParameters = function (a) { d = a; return d }; this.DefaultValue = function (b, a) { this.SearchResultsTipId.val(b); this.SearchInput.val(a); return this }; this.Value = function () { return { k: a.SearchResultsTipId.val(), v: a.SearchInput.val() } }; var b = { setResultsPosition: function () { var c = a.SearchInput.offset(), d = b.objectWH(a.SearchInput); a.SearchResults.css("left", c.left).css("top", c.top + d.height - 4).css("width", d.width - 4) }, retrieveResults: function (c) { if (c && c.length > 0) { var e = {}; if (d && typeof d === "object") e = d, e.searchquery = c; else e = { searchquery: c }; jQuery.ajax({ async: true, url: a.SearchUrl, type: "POST", data: e, success: function (a) { b.fillResults(a) } }) } }, fillResults: function (c) { a.SearchResults.empty().hide(); a.SearchInputTip.val(""); if (c && c.length > 1) { jQuery(c).each(function (c, b) { a.SearchResults.append('<div class="row" id="' + b.k + '">' + b.v + "</div>") }); a.SearchResults.find("div").unbind().click(function () { jQuery(this).addClass("selected"); b.resultsApply() }).end().css("height", c.length * 19).show() } else if (c && c.length == 1) { var e = a.SearchInput.val().length, d = c[0].v, f = c[0].k, g = a.SearchInput.val() + d.substring(e, d.length); a.SearchResultsTipId.val(f); a.SearchInputTip.val(g) } }, resultsMove: function (d) { var b = -1, c = a.SearchResults.find(".row").length - 1; jQuery(a.SearchResults.children()).each(function (a, c) { if (jQuery(c).hasClass("selected")) { b = a; return } }); if (d == "up") { if (b > 0) { b--; a.SearchResults.find("div.selected").removeClass("selected").end().find("div:eq(" + b + ")").addClass("selected") } } else if (b < c) { b++; a.SearchResults.find("div.selected").removeClass("selected").end().find("div:eq(" + b + ")").addClass("selected") } }, resultsApply: function () { var b = 0; if (a.SearchResultsTipId.val() != "" || a.SearchResults.find("div").length > 0) { if (a.SearchResults.is(":visible")) { b = a.SearchResults.find(".selected").attr("id"); a.SearchInput.val(a.SearchResults.find(".selected").html()); a.SearchInputTip.val(""); a.SearchResultsTipId.val(b); a.SearchResults.empty().hide() } else { b = a.SearchResultsTipId.val(); a.SearchInput.val(a.SearchInputTip.val()); a.SearchInputTip.val("") } if (!a.isApplied) { f && typeof f === "function" && f(b); a.isApplied = true } } return b }, objectWH: function (b) { var a = { width: 0, height: 0 }; a.height += b.css("height").replace("px", "") * 1; a.height += b.css("margin-top").replace("px", "") * 1; a.height += b.css("margin-bottom").replace("px", "") * 1; a.height += b.css("border-top-width").replace("px", "") * 1; a.height += b.css("border-bottom-width").replace("px", "") * 1; a.width += b.css("width").replace("px", "") * 1; a.width += b.css("margin-left").replace("px", "") * 1; a.width += b.css("margin-right").replace("px", "") * 1; a.width += b.css("border-left-width").replace("px", "") * 1; a.width += b.css("border-right-width").replace("px", "") * 1; return a } }, g = jQuery("." + h); if (g.length > 0) { g.append(this.SearchInputLabel).append(this.SearchInput).append(this.SearchInputTip).append(this.SearchResultsTipId).append(this.SearchResults); jQuery(window).resize(function () { b.setResultsPosition() }).trigger("resize"); this.SearchInput.keydown(function (c) { var f = a.SearchInput.val(), d = f.length; if (c.which > 32 && c.which != 40 && c.which != 38 && c.which != 9 && c.which != 39 && c.which != 46 && c.which != 13) return true; else if (c.which == 8 || c.which == 46) { d - 1 > 0 && b.retrieveResults(f.substring(0, d - 1)); if (a.isApplied) { a.isApplied = false; a.SearchResultsTipId.val(""); e && typeof e === "function" && e() } } else if (c.which == 40) b.resultsMove("down"); else if (c.which == 38) b.resultsMove("up"); else if (c.which == 39) b.resultsApply(); else if (c.which == 9) { b.resultsApply(); return false } else c.which == 13 && b.resultsApply() }).keypress(function (c) { var f = a.SearchInput.val(), d = String.fromCharCode(c.which || c.keyCode), e = f + d; b.retrieveResults(e) }) } return this }